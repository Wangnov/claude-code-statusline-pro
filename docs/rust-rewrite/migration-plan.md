# TypeScript → Rust 迁移路线图

> 将迁移划分为三个可交付里程碑，确保功能等价与可验证的性能改进。

## 里程碑概览

| 里程碑 | 时间 | 交付物 | 目标 |
|--------|------|--------|------|
| **A. 兼容性基线** | 2 周 | Rust CLI 复刻 TS 输出；输入/配置解析；核心组件（Project/Model/Branch/Tokens/Usage/Status）；对等测试脚本 | CLI 行为与 TypeScript 完全一致 |
| **B. 特性补齐** | 2~3 周 | 主题、终端检测、Widget/多行（可选）、Git/存储与 TS 功能对齐；文档和示例更新 | 保持功能等价，验证 Git/存储回退策略 |
| **C. 性能与发布** | 待定（取决于实测） | 性能基准、必要优化（基于 Profiling）、CI/包装脚本、发布通道 | 基于数据的优化与发布准备 |

> 阶段间可并行处理测试/文档工作，但不得跳过里程碑 A 的对等验证。

## 里程碑 A：兼容性基线

1. **输入解析**：按 `docs/rust-rewrite/data-structures.md` 定义实现 `InputData`，确保对缺失字段友好。
2. **配置加载**：复刻 `ConfigLoader` 的搜索序列与合并逻辑；引入单元测试覆盖。
3. **组件系统**：迁移六大组件，确保渲染结果与 TypeScript 对应组件一致。
4. **终端降级策略**：实现 Nerd Font / Emoji / Text 三态选择，提供 `--debug` 输出。
5. **对等测试**：编写脚本比较 TS 与 Rust 输出（同一输入数据），记录差异。

完成标准：对给定测试夹具，Rust 输出逐字节匹配 TypeScript；`cargo test`、`cargo fmt`、`cargo clippy` 全通过。

## 里程碑 B：特性补齐

1. **主题系统**：实现 Classic/Powerline/Capsule 渲染，保持样式一致。
2. **多行与 Widget（可选）**：若 TypeScript 功能启用，需要迁移对应配置解析与渲染；若暂未启用，可提供占位实现。
3. **Git/存储**：按 `git-storage.md` 计划，先实现 CLI 方案，再评估 `git2` 引入；存储沿用 JSON。
4. **CLI 子命令**：完成 `config`、`theme`、`--mock` 等辅助功能。
5. **文档与示例**：更新 README、手册、验证脚本。

完成标准：Rust 覆盖 TypeScript 主功能，所有 CLI 选项可用；对多组真实数据完成对等测试。

## 里程碑 C：性能与发布

1. **基准建立**：收集 TypeScript 冷启动/热渲染数据，形成基线报告。
2. **性能优化**：根据 Profiling 结果决定是否启用 `lto`、缓存、并行等；逐项验证收益与风险。
3. **CI / 发布**：完善 GitHub Actions，增加跨平台构建与测试；准备 npm/cargo 等发布流程。
4. **回滚与迁移**：文档化回滚手段与用户迁移指南，确保发布后可快速响应问题。

完成标准：性能报告显示在关键场景优于或至少不逊于 TypeScript；发布流程可重复执行。

## 风险与缓解

- **需求漂移**：出现新功能或配置调整时，先更新文档与 TypeScript 参考实现，再实施迁移。
- **性能目标不明**：无基线前，不承诺具体指标；以真实测量驱动优化方案。
- **依赖兼容性**：关注 `clap`/`git2`/`crossterm` 等 crate 的 MSRV，必要时锁定版本。

> 当计划发生变化，请以 PR 更新本文档，再同步团队认知。
